<html lang="en-US">
<head>
	
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Active Component Example</title>

	
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<!-- Latest compiled and minified CSS fro select UI-->
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">
	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
	<!-- Jquery to allow resizable -->
	<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
	<!-- Custom styles for this project -->
    <link type="text/css" rel="stylesheet" href="css/application.css"/>

    <link href="css/owfont-regular.css" rel="stylesheet" type="text/css">

	<script src="js/jquery-3.2.1.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<!-- Latest compiled and minified JavaScript for select UI-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jplayer/2.9.2/add-on/jplayer.playlist.js"></script>
	<script src="js/mainfunctions.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.12.0.js"></script>


	
</head>

<body>
	<nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>


    <div class="container">


		<div class="starter-project">
			<h1>Active Component Starter Project</h1>
			<p class="lead">Use this website to play with the existing active components. Pick one from the spinner below and select your favorite UI component to link the UI to the active component's functionality.</p>
			<p id="connStatus">Waiting to connect to server...</p>
		</div>
		<div align=center>
			<select id="selectAC" class="selectpicker" onchange="addAC()" data-width="fit" data-style="btn-primary" data-dropup-auto="false">
			    <option>Choose an active component</option>
			</select>
		</div>
		<div align=center>
			<button id="calculator" type="button" class="btn btn-primary" onclick="window.open('file:///C:/Users/Asanctor/Documents/Ionic Tutorial/CodeDB/startmyprg.bat')">Open Calculator</button>
			<a href='C:\Users\Asanctor\Downloads\Music\Fall Out Boys - Immortals.mp3'>Play Song</a>
			<button id="calculator" type="button" class="btn btn-primary" onclick="window.open('http://google.com');">Click On</button>
			<button id="voice" type="button" class="btn btn-primary" onclick=voice()>Voice</button>
			<button id="weather" type"button" class="btn btn-warning" onclick=getWeather()>Weather</button>

			<div class="panel panel-success" style="width:300px">
				<div id="city" class="panel-heading text-left">City</div>
				<div class="row" style="position: relative; top: 15px;">
					<div class="col-xs-6">
						<div id="today" style="font-size: 14">Fri 20/5</div>
						<div style="font-size: 40"><span id="temp" style="font-size: 40">27</span>Â°<span style="font-size: 30">C</span></div>
					</div>
					<div class="col-xs-6" style="height:100px;">
						<i id="icon"  class="owf owf-500 owf-5x"></i>
					</div>
				</div>
			</div>
			<a onclick="window.open('C:/Users/Asanctor/Pictures')">CLICK ME</a>
			
			<input id="filechoser" type="file" multiple/>
			<img src="" width="200" style="display:none;" />
			<audio id="myaudio" controls="controls">
				<source id="song" src"" type="audio/mp3">
			    <!--source id="oo" src="C:/Users/Asanctor/Downloads/Music/Alan Walker - Faded (Restrung).mp3" type="audio/mp3">
			    <source id="oo" src="C:/Users/Asanctor/Downloads/Music/Coldplay - Hymn For The Weekend.mp3" type="audio/mp3"-->
			</audio>
		</div>
		<div align=center id="voiceBox">
			Here is my voice</textarea>
		</div>


		<!--div class="panel panel-primary">
			<div class="panel-heading">
                <p> <span class="glyphicon glyphicon-comment"></span> Channel 1 </p>
            </div>
            <div class="panel-footer">
            	<p>Type your message and press enter</p>
				<div class="input-group">
					<input id="input" class="form-control" placeholder="Type your message here"/>
					<span class="input-group-btn">
	                    <button class="btn btn-warning btn-sm" id="btn-chat">Send</button>
	                </span>
				</div>
			</div>
        	<div class="panel-body">
                <div id="box" class="chat">
            </div>
        </div-->

		

    </div><!-- /.container -->


	<!--div class="banner-section" id="banner-img">
		<img src="http://localhost:8080/api/v1/uis/img?name=Publisher1"></img>
    </div-->
	

    <!-- first modal to ask parameters from the user -->
	<div class="modal fade" id="parameterModal" tabindex="-1" role="dialog" aria-labelledby="parameterModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h4 class="modal-title" id="myModalLabel">Fill in the Active Component's parameter(s)</h4>
		  </div>
		  <div class="modal-body" id="parameterModalBody">
			
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			<button id="validate" type="button" class="btn btn-primary">Validate</button>
		  </div>
		</div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->


	<div class="modal fade" id="chooseUIModal" tabindex="-1" role="dialog" aria-labelledby="chooseUIModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h4 class="modal-title" id="chooseUIModalLabel">Choose a UI</h4>
		  </div>
		  <div class="modal-body" id="uiModalBody">

			  



		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			<button id="validateUI" type="button" class="btn btn-primary">Validate</button>
		  </div>
		</div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->


<script type="text/javascript">

	

/* -----------------------GLOBAL VARIABLES ---------------------- */
	
	var nodes = [];
	var links = [];
	
	//TODO: populate with ACs on server
	var select = document.getElementById("selectAC"); 
	var options = ["publisher", "subscriber", "urlOpener", "musicPlayer", "weather", "YoutubePlayer"];



//$.getJSON(server, { name: 'Publisher'}, function( data ) {
//var server = "http://localhost:8080/api/v1/uis/img3?";



	var publisher;
	//populate dropdown
	for(var i=0; i < options.length; i++){
		var opt = options[i];
	    var el = document.createElement("option");
	    el.textContent = opt;
	    el.value = opt;
	    select.appendChild(el);
	}
	
	
	addAC = function(){
		var ac = document.getElementById('selectAC').value;
		lookupComp(ac);
	}
	
	askComp = function(){
		
		var comp = document.getElementById("textareaID").value;
		lookupComp(comp);
		$('#myModal').modal('hide');
		
	}
	
	$('#myModal').on('shown.bs.modal', function () {
		$('#textareaID').focus();
	})	
	
	$('button').button().draggable({cancel:false});
	
	
/*	$('#filechoser').change(function (url) {
		var tmppath = URL.createObjectURL(event.target.files[0]);
    	$("img").fadeIn("fast").attr('src',URL.createObjectURL(event.target.files[0]));
	})	*/
	var _next = 0;
	var fileArray = [];

	$('#filechoser').change(function (evt) {
		console.log(evt.target.files);
		var sound = document.getElementById('myaudio');
    	sound.src = URL.createObjectURL(this.files[_next]);
    	sound.play();

    	for (var i = 0; i < this.files.length; i++) {
    		fileArray.push(this.files[i]);
    	}

		// not really needed in this exact case, but since it is really important in other cases,
		// don't forget to revoke the blobURI when you don't need it
		sound.onend = function(e) {
    		URL.revokeObjectURL(this.src);
  		}
	})	

	var myaudio = document.getElementById("myaudio");
	myaudio.addEventListener("ended", function(){
	   	_next += 1;
	   	if(_next < fileArray.length){
	   		var sound = document.getElementById('myaudio');
	   		//set audio to next song
    		sound.src = URL.createObjectURL(fileArray[_next]);
    		sound.play();
	   	}
	   	
	});

	function openInNewTab(url) {
	  window.open('http://google.com');
	}

	var box = document.getElementById("voiceBox");
	var recognition;
	function voice(){

		recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
		recognition.lang = 'en-US';
		recognition.interimResults = false;
		recognition.maxAlternatives = 5;
		recognition.start();

		recognition.onresult = function(event) {
			box.innerHTML = (''+event.results[0][0].transcript).replace( /[<>]/g, '' ) + '<br>' + self.box.innerHTML
		    console.log('You said: ', event.results[0][0].transcript);
		};

				[
		 'onaudiostart',
		 'onaudioend',
		 'onend',
		 'onerror',
		 'onnomatch',
		 'onsoundstart',
		 'onsoundend',
		 'onspeechend',
		 'onstart'
		].forEach(function(eventName) {
		    recognition[eventName] = function(e) {
		        console.log(eventName, e);
		    };
		});

	}


var getWeather = function() {

    var server = "http://localhost:8080/api/v1/";
    var serverAC = server + "acs/name?";

    $.getJSON(serverAC, {name: "weather"}, function (data) {
        var parameterArray = data.parameters;
        for (var i = 0; i < parameterArray.length; i++) {
            parameterArray[i].value = "Ixelles";
        }
        var serverUI = server + "uis/name?";
        $.getJSON(serverUI, {name: "weatherUI"}, function (uiData) {

            //var serverUI = server + "uis/"
            var script = document.createElement('script');
            var uiElement = uiData[0];
            script.setAttribute('type', 'text/javascript');
            script.innerHTML = uiElement.code;
            document.getElementsByTagName('head')[0].appendChild(script);

            var ui = new WeatherUI(parameterArray);
            ui.displayUI();

            //link AC functionality to UI
           /* var acScript = document.createElement('script');

            acScript.setAttribute('type', 'text/javascript');
            acScript.innerHTML = data.code;
            $("head").append(acScript);
*/
            var component = new Weather(parameterArray);
            var uiParameterArray = data.uiParameters;
            for (var n = 0; n < uiParameterArray.length; n++) {
                var name = uiParameterArray[n].name;
                //ask from UI object the value of its attributes, e.g. ui.area, which corresponds to the id of this UI element
                uiParameterArray[n].value = ui[name];
            }
            component.initialise(uiParameterArray);

            var arr = [{name:"ac", value:component},{name:"time", value:"3000"}];
            var poker = new TimePoker(arr);

        });
    });
}

/*
	var key = "db781705d2bba8a45dd4c37204325aab";
	var city = "Brussels";
	var options = {
		host: 'api.openweathermap.org',
		path: '/data/2.5/find?q=' + city + '&units=metric&appid=' + key
	};
	var weather =   "http://api.openweathermap.org/data/2.5/find?q=" + city + "&units=metric&appid=" + key;

	function getWeather(){
		$.getJSON( weather, function( wData ) {
			console.log(wData);
            var wCity = wData.list[0].name; // to see if we got the right city
            var temperature = wData.list[0].main.temp;
            var wIcon = wData.list[0].weather[0].id;

            //update UI elementsw
            document.getElementById("city").innerHTML =  wCity;
            document.getElementById("temp").innerHTML =  Math.round(temperature);
            document.getElementById("icon").className = "owf owf-" + wIcon + " owf-5x";
		})
	}

	var today = new Date();
	var dd = today.getDate();
	var mm = today.getMonth()+1; //January is 0!

	if(dd<10) {
		dd = '0'+dd
	}

	if(mm<10) {
		mm = '0'+mm
	}
	var weekday = new Array('Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday');
    var dayOfWeek = weekday[today.getDay()].substr(0, 3);

	document.getElementById("today").innerHTML = dayOfWeek + " " + dd + '/' + mm;
*/

	/*$('#calculator').on('click', function launchCalc()
	{
	 var WshShell = new ActiveXObject("WScript.Shell");
	 WshShell.Run("calc.exe");
	})*/
		

	/* // source:https://www.pubnub.com/developers/demos/10chat/
	(function(){
      var pubnub = new PubNub({ publishKey : 'pub-c-593f99ef-228e-4531-8cb8-30eaeb88666c', subscribeKey : 'sub-c-f6d29f98-5d7b-11e7-b272-02ee2ddab7fe' });
      function $(id) { return document.getElementById(id); }
      var box = $('box');
      var input = $('input');
      var channel = '10chat-demo';
      //each time listener receives object, add the message in box div
      pubnub.addListener({
          message: function(obj) {
              box.innerHTML = (''+obj.message).replace( /[<>]/g, '' ) + '<br>' + box.innerHTML
          }});
      //subscribe to chat-channel
      pubnub.subscribe({channels:[channel]});
      //when "enter" is pressed publish the content of the input field
      input.addEventListener('keyup', function(e) {
          if ((e.keyCode || e.charCode) === 13) {
            pubnub.publish({channel : channel,message : input.value,x : (input.value='')});
        }
      });
	})();*/

/*
function Weather(nameCityPara) {

    // search for right parameter in parameter array
    for(var l = 0; l < nameCityPara.length; l++){
        if(nameCityPara[l].name == "cityName"){
            this.city = nameCityPara[l].value;
        }
    }

    if(this.city == null){
        console.log("Error, city not given!!");
    }

    //key needed for weather API
    this.key = "db781705d2bba8a45dd4c37204325aab";

    this.weather =   "http://api.openweathermap.org/data/2.5/find?q=" + this.city + "&units=metric&appid=" + this.key;


    console.log("weather");


}

//weather functionality should be linked to an area UI
//following function takes the ids of the UI component and link it to functionality
Weather.prototype.initialise = function(uiPara){

    var self = this;

    // search for right parameter in parameter array being the area and link it to the correct attribute
    for(var m = 0; m < uiPara.length; m++){
        if(uiPara[m].name == "city"){
            self.cityArea = document.getElementById(uiPara[m].value);
        } else if(uiPara[m].name == "temperature") {
            self.tempArea = document.getElementById(uiPara[m].value);
        } else if(uiPara[m].name == "icon") {
            self.icon = document.getElementById(uiPara[m].value);
        } else if(uiPara[m].name == "date") {
            self.date = document.getElementById(uiPara[m].value);
        }
    }

    self.update();

}

//general function to update the weather in area UI (used by poker AC)
Weather.prototype.update = function(){

    var self = this;

    $.getJSON( self.weather, function( wData ) {
        self.wCity = wData.list[0].name; // to see if we got the right city
        self.wTemperature = wData.list[0].main.temp;
        self.wIcon = wData.list[0].weather[0].id;

        console.log(wData);
        //update UI elements
        self.cityArea.innerHTML = self.wCity;
        self.tempArea.innerHTML = Math.round(self.wTemperature);
        self.icon.className = "owf owf-" + self.wIcon + " owf-3x";

        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth()+1; //January is 0!

        if(dd<10) {
            dd = '0'+dd
        }

        if(mm<10) {
            mm = '0'+mm
        }
        var weekday = new Array('Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday');
        var dayOfWeek = weekday[today.getDay()].substr(0, 3);

        self.date.innerHTML = dayOfWeek + " " + dd + '/' + mm;
    })

}


var YouTubePlayer = class YouTubePlayer {

    constructor(playerPara) {
        // search for right parameter in parameter array
        for(var l = 0; l < playerPara.length; l++){
            if(playerPara[l].name == "playerName"){
                this.name = playerPara[l].value;
            } else if(playerPara[l].name == "playerUrl"){ //for now url is just videoID, later we can split string to get that id from an actual url
                this.url = playerPara[l].value;
            }
        }

        this.box;
        this.player;

        if(this.name == null){
            this.name = "YTPlayer1";
        }

    }

    //player functionality should be linked to an area UI
    //following function takes the id of this area UI component and link it to functionality
    initialise(uiPara) {

        var self = this;

        // 2. This code loads the IFrame Player API code asynchronously.
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // search for right parameter in parameter array being the area and input
        for(var m = 0; m < uiPara.length; m++){
            if(uiPara[m].name == "area"){
                self.box = uiPara[m].value;
            }
        }

        window.onYouTubeIframeAPIReady = function() {
            self.player = new YT.Player(self.box, {
                height: '390',
                width: '640',
                videoId: self.url,
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            event.target.playVideo();
        }

        function onPlayerStateChange(event) {

            //when user goes to other position it is also seen as paused for a while
            if(event.data == 2){
                console.log("paused");
                console.log(self.player.getCurrentTime());
            }
            if(event.data == 1){
                console.log("playing");
            }
            if(event.data == 3){
                console.log("buffering");
            }
        }
    }
}

/*
function YouTubePlayerUI(playerPara) {

    // search for right parameter in parameter array
    for(var l = 0; l < playerPara.length; l++){
        if(playerPara[l].name == "playerName"){
            this.name = playerPara[l].value;
        }
    }

    if(this.name == null){
        this.name = "Player1";
    }


    //field that should be linked to some functionality
    this.area = "box" + this.name;

}

YouTubePlayerUI.prototype.displayUI = function(){


    var newDiv = document.createElement("div");
    newDiv.setAttribute("id", "player"+this.name);
    newDiv.setAttribute("class", "panel panel-primary");

    var innerDiv1 = document.createElement("div");
    innerDiv1.setAttribute("class", "panel-heading");
    innerDiv1.setAttribute("id", "player"+this.name+"heading");
    var span = document.createElement("span");
    span.setAttribute("class", "glyphicon glyphicon-play")

    var innerContent1 = document.createTextNode(" " + this.name);

    span.appendChild(innerContent1);
    innerDiv1.appendChild(span);

    var innerDiv2 = document.createElement("div");
    innerDiv2.setAttribute("class", "panel-body");
    var innerInnerDiv2 = document.createElement("div");
    innerInnerDiv2.setAttribute("id", "box"+this.name);

    innerDiv2.appendChild(innerInnerDiv2);

    newDiv.appendChild(innerDiv1);
    newDiv.appendChild(innerDiv2);

    document.body.appendChild(newDiv);
    $("#player"+this.name).draggable({cancel:false, handle:'#player'+this.name+'heading'});
    //only horizontaly resizable
    $("#player"+this.name).resizable({grid: [1, 10000]});
} */


/*if (!!window.EventSource) {

	var connStatus = document.getElementById('connStatus');

	function connectionOpen(open){
		connStatus.className = open ? 'open' : '';
		connStatus.innerHTML = open ? 'Active connection to server' : 'Connection dropped - trying to reopen';
	}


    const source = new EventSource('http://localhost:8080/api/competition');


	source.onopen = function() {
		connectionOpen(true);
        console.log("open");
	};
	source.onerror = function () {
		connectionOpen(false);
        console.log("error");
	};

	/*source.addEventListener('connections', updateConnections, false);
	source.addEventListener('requests', updateRequests, false);
	source.addEventListener('uptime', updateUptime, false);*/

	/*source.onmessage = function (event) {
		// a message without a type was fired
		console.log(event);
	};*/
/*} else {
    // Result to xhr polling :(
}*/

var newDiv = document.createElement("div");
newDiv.setAttribute("id", "buttonDiv");
newDiv.setAttribute("style", "display: inline-block; top: 43; left: 690;");

var newButton = document.createElement("button");
newButton.setAttribute("id", "buttonB");
newButton.setAttribute("class", "btn btn-primary btn-lg");
newButton.setAttribute("style", "border-radius: 50%; height: 162px; width: 161px;");
newButton.setAttribute("type", "button");
newButton.innerHTML = "bla";

newDiv.appendChild(newButton);
document.body.appendChild(newDiv);

//TODO: resize DIV!!!
$("#buttonB").resizable({grid: 10, stop: function (event, ui) {console.log(ui.size)}});
$("#buttonDiv").draggable({
    cancel:false,
    grid: [ 10,10 ],
    stop: function (event, ui) {
        console.log(ui.position)
        console.log(ui);
        $.post( "http://localhost:8080/api/streams/" + '{"left": ' + ui.position.left + ', "top": ' + ui.position.top + '}');
    }
});

var source;
function onPageLoad() {
	setupEventSource();
}
window.addEventListener("load", onPageLoad, true);

function setupEventSource() {
    if (typeof(EventSource) == "undefined") {
        Alert("Error: Server-Sent Events are not supported in your browser");
        return;
    }
    // Check if already connected to avoid getting duplicate messages
    if (typeof(source) !== "undefined") {
        source.close();
    }

    console.log("Setting up new event source");
    source = new EventSource("http://localhost:8080/api/streams");

    source.onopen = function() {
        console.log("SSE onopen");
    }

    source.addEventListener("move", function (data) {
		var js = JSON.parse(data.data);
		console.log(js);
        $("#buttonDiv").css(js);
        //document.getElementById("buttonDiv").setAttribute("style", "left:" + js.left + ";");
        //document.getElementById("buttonDiv").setAttribute("style", "top:" + js.top + ";");
    })

    source.onmessage = function(event) {
        console.log("SSE onmessage: " + event.data);
        if ( event.name==="move" ) {
            var js = JSON.parse(data.data);
            document.getElementById("buttonDiv").setAttribute("style", "left:" + js.left + ";");
            document.getElementById("buttonDiv").setAttribute("style", "top:" + js.top + ";");
        }

        /*if ( event.data==='start' ) {
            // safely ignore this
            return;
        }


        // Parse the message and update the values
        var obj = JSON.parse(event.data);
        if ( obj.id == lastMsgId ) {
            // ignore duplicate
            return;
        }
        lastMsgId = obj.id;

        if ( obj.type === 'devicedata' ) {
            setSystolic(obj.systolic);
            setDiastolic(obj.diastolic);
            setSPO2(obj.spo);
            setHeartrate(obj.heartrate);
            setWeight(obj.weight);
        }*/
    }
    source.onerror = function(event) {
        console.log("SSE onerror " + event);
    }
}

  </script>
</body>

</html>